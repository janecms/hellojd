## 如何配置和调谐电路

部署新电路器的典型方法是通过自由配置（超时/线程/信号量）将其释放到生产中，然后在看到它经历高峰生产周期后将其调整到更严格的配置。
在实践中，这通常是这样的：
- 默认默认为1000ms超时，除非知道需要更多的时间。
- 将线程池默认为10个线程，除非知道需要更多的线程。
- 部署到金丝雀 如果一切顺利，继续。？？
- 在生产环境24小时。
- 依靠标准的警报和监控来捕捉问题。
- 24小时后，使用延迟百分位数和流量来计算电路有意义的最低配置值。
- 在生产中即时更改值，并使用实时仪表板监控它们，直到您有信心。
- 只有当电路的行为或性能特征发生变化并通过警报和/或仪表板监控引起您的注意时，才再次考虑该电路的配置。

下图显示了一个典型的思考过程，显示了如何选择线程池，队列和执行超时（或信号量大小）的大小：
![thread-configuration](https://github.com/Netflix/Hystrix/wiki/images/thread-configuration-640.png)

对于大多数电路，您应该尝试将其超时值设置为接近正常健康系统的99.5%，以便它们将切断不良请求，而不会让它们占用系统资源或影响用户行为。
您必须设置线程池和队列的大小，以便它们占整个应用程序资源的一小部分，否则它们将无法防止依赖关系饱和可用资源。
配置和调优电路的重要内容是：

- 您应该在生产中进行调整，并根据实际流量模式进行调整
- 您可以在监控时轻松地实时调整设置，以查看不同设置的影响

## 预料抖动和失败
Hystrix测量和报告以毫秒为粒度。 可能“抖动”-被视为超时突发，线程池拒绝，减速等等。 在大型集群中，通常有一些这些事情在任何特定的时间发生，用于大容量电路。
Hystrix捕获的指标的这种粒度是许多软件系统没有的，所以这些报告可能导致不必要的担心。
在Netflix API仪表板的屏幕截图中，它监视生产中的Hystrix命令，您可以看到橙色和紫色数字，显示在表示243个服务器的10秒统计窗口中少量请求中发生的超时和线程池拒绝。
![circuit-identity](https://github.com/Netflix/Hystrix/wiki/images/circuit-identity-jitter-640.png)
大多数系统都是以相当高的水平进行测量的 - 设置是每分钟完成百分位数延迟。 此外，它通常是针对整个应用程序请求循环完成的，而不是与每个单独的依赖关系进行交互。 在Hystrix你会得到一个更好的调整的看法，发生了什么。
 一旦您精细观察到显示每个依赖关系发生了什么，不要惊讶地看到以前可能看不到的抖动。
一些原因:
- 客户端机器垃圾收集（您的机器在请求中间执行垃圾收集）
- 服务机器垃圾收集（远程服务器在请求中间执行垃圾收集）
- 网络问题
- 不同请求参数的不同有效载荷大小
- 缓存未命中
- 突发呼叫模式
- 新机启动（部署，自动扩展事件）和“升温” 

如果你注意到了潜在因素，请不要通过跳转来重新配置。如果Hystrix命令正在减少负载，那么它正在做它应该做的事情。
在Netflix采用Hystrix的早期，当一个电路成为潜在的动态改变属性以增加线程池，队列，超时，等等“尝试给它一些喘息的空间”，让它再次工作。但这与你应该做的相反。如果您正确配置了一个健康系统的命令，并且它正在拒绝，超时和/或短路，那么您应该专注于修复根本的根本原因。
不要给命令过多的资源，

例如，假设您拥有一组100台服务器，每个服务器与允许的服务具有10个并发连接，即：1000个可能的并发连接。 健康时，通常在任何时候使用200-300。 如果延迟发生并将其全部恢复，您现在正在使用1000个连接。 每个盒子10个可能看起来不太适合客户端，所以让我们尝试将其增加到20个，对吧？ 
最可能的是，如果10饱和，20也会饱和。 现在你有2000个连接在后端打开，使事情更糟。
这是断路器存在的原因之一 - 在底层系统上“释放压力”，让它们恢复，而不是用更多的请求来重试循环，挂起连接等。

例如，以下是单个依赖关系的一个示例，它遇到延迟，导致超时时间足够高以使断路器在集群的大约三分之一上跳闸。 
这是系统中唯一有健康问题的电路，Hystrix阻止其在具有延迟问题的情况下使用其他资源。
![ops-social](https://github.com/Netflix/Hystrix/wiki/images/ops-social-640.png)

简而言之，让系统减轻负载，短路，超时和拒绝，直到底层系统再次健康，进行自我保护。 
Hystrix是专为这种情况设计的，重点是减少潜在系统的资源利用率，以便通过将大部分资源与潜在连接上挂起的资源隔离开来，
从而快速发生恢复。

## 什么是依赖失败情况

分布式系统中，最典型的故障类型是单个依赖关系失败，其他保持健康。这种情况下，仪表盘显示非常明显。
![ops-cinematch-1](https://github.com/Netflix/Hystrix/wiki/images/ops-cinematch-1-640.png)
上述屏幕截图显示了具有20％错误率的单个电路：不足以启动断路器跳闸。 其他三个电路不受影响。
在这个特殊的例子中，它是实际的错误，而不是延迟，导致了问题 - 如红色数字而不是橙色所示。
在同一事件中捕获了以下图表，以显示该电路的历史趋势，以及如何在故障和后退中引起注意。
![/ops-cinematch-2](https://github.com/Netflix/Hystrix/wiki/images/ops-cinematch-2-640.png)

## 依赖失败与后备
这是影响单个电路的另一个事件的屏幕截图。 请注意，第99.5百分位数的延迟非常高。 这是底层工作线程完成的时间，这又会使线程池饱和并导致调用线程超时。
集群中除了一台机器外，所有的断路器都跳闸，导致大部分流量短路（蓝色），而在一台机器上仍然尝试大部分请求被超时（橙色）。
![ops-getbookmarks](https://github.com/Netflix/Hystrix/wiki/images/ops-getbookmarks-640.png)
请注意，其他电路是健康的，左边的线形图显示没有返回的500s的增加，因为该电路返回后退，所以用户正在接收降级的体验。

## 级联依赖失败
这个屏幕截图代表了一个严重依赖于许多其他系统的单一系统的故障（在这种情况下是高延迟），因此发生了级联故障。
以下屏幕截图显示了表示三种不同系统的六个电路：
![ops-ab-640](https://github.com/Netflix/Hystrix/wiki/images/ops-ab-640.png)
在这次事件发生的时候，Hystrix仍然主要是“Netflix-API”的事情。 随着Hystrix越来越多的Netflix团队，这进一步限制了级联故障的影响，如下图所示：
![cascading-failure-preventing](https://github.com/Netflix/Hystrix/wiki/images/cascading-failure-preventing-640.png)

## When It’s You, Not The Dependency
如果所有的电路看起来都很糟糕（仪表板全部亮起来），那么系统很有可能出现问题，而不是所有的依赖项都在同一时间。
![ops-complete-system](https://github.com/Netflix/Hystrix/wiki/images/ops-complete-system-640.png)
可能导致这种情况的系统问题的2个示例如下：
     系统过载（高负载平均，CPU使用率等）
         可能发生这种情况的一个例子是，如果自动缩放策略失败或者速度不够快，流量激增，并且机器的接收流量超过可以处理的数量。
     内存泄漏最终导致GC敲击，从而窃取CPU并导致暂停，从而导致电路超时，备份和拒绝

